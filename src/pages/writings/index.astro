---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const allPosts = (await getCollection('blog')).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Extract unique categories
const categories = [
    'All',
    ...new Set(allPosts.flatMap((post) => post.data.categories)),
];

// Group posts by year
const postsByYear = allPosts.reduce(
    (acc, post) => {
        const year = post.data.pubDate.getFullYear();
        if (!acc[year]) {
            acc[year] = [];
        }
        acc[year].push(post);
        return acc;
    },
    {} as Record<number, typeof allPosts>,
);

const years = Object.keys(postsByYear)
    .map(Number)
    .sort((a, b) => b - a);

// Create a flat list for easier rendering and pagination
// Items can be { type: 'year', year: number, count: number } or { type: 'post', post: Post }
type ListItem =
    | { type: 'year'; year: number; count: number; id: string }
    | { type: 'post'; post: (typeof allPosts)[0]; year: number; id: string };

const flatList: ListItem[] = [];
years.forEach((year) => {
    flatList.push({
        type: 'year',
        year,
        count: postsByYear[year].length,
        id: `year-${year}`,
    });
    postsByYear[year].forEach((post) => {
        flatList.push({
            type: 'post',
            post,
            year,
            id: post.id,
        });
    });
});

const formatDate = (date: Date) => {
    return date.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
    });
};
---

<Layout title="Blog | Savitha">
    <div class="max-w-6xl mx-auto px-4 py-8 md:py-12">
        <header class="mb-12">
            <h1
                class="text-4xl md:text-5xl font-comic-heading text-black mb-6 transform -rotate-1 w-fit"
            >
                <span
                    class="bg-primary text-white px-4 py-2 inline-block shadow-[4px_4px_0_0_#000] border-black border-2"
                >
                    My Writings
                </span>
            </h1>
            <p class="text-xl font-comic-body text-black mb-8 max-w-xl">
                Guides, references, and tutorials on programming, web
                development, and design.
            </p>

            <div class="relative max-w-md">
                <div
                    class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="2.5"
                        stroke="currentColor"
                        class="w-5 h-5 text-black"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
                        ></path>
                    </svg>
                </div>
                <input
                    type="text"
                    id="search-input"
                    class="block w-full pl-10 pr-3 py-3 border-2 border-black shadow-[4px_4px_0_0_#000] rounded-none leading-5 bg-white text-black placeholder-gray-500 focus:outline-none focus:translate-y-[2px] focus:shadow-[2px_2px_0_0_#000] transition-all font-comic-body"
                    placeholder={`Search ${allPosts.length} posts...`}
                />
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-[1fr_250px] gap-12">
            <!-- Main Content -->
            <main>
                <div id="blog-list" class="space-y-4">
                    {
                        flatList.map((item, index) => {
                            if (item.type === 'year') {
                                return (
                                    <div
                                        class={`list-item year-header group-${item.year} mt-12 first:mt-0 mb-4 flex items-baseline gap-3 pb-2 border-b-4 border-black border-dashed ${index >= 10 ? 'hidden' : ''}`}
                                        data-type="year"
                                        data-year={item.year}
                                    >
                                        <h2 class="text-4xl font-bold text-black font-comic-heading transform -rotate-1">
                                            {item.year}
                                        </h2>
                                        <span class="text-text-muted font-bold font-comic-body bg-white border-2 border-black px-2 py-0.5 shadow-[2px_2px_0_0_#000] text-sm transform rotate-2">
                                            {item.count} post
                                            {item.count !== 1 ? 's' : ''}
                                        </span>
                                    </div>
                                );
                            } else {
                                return (
                                    <article
                                        class={`list-item post-item group-${item.year} py-3 px-2 hover:bg-yellow-50 transition-colors border-l-4 border-transparent hover:border-black ${index >= 10 ? 'hidden' : ''}`}
                                        data-type="post"
                                        data-year={item.year}
                                        data-title={item.post.data.title.toLowerCase()}
                                        data-categories={JSON.stringify(
                                            item.post.data.categories,
                                        )}
                                    >
                                        <a
                                            href={`/writings/${item.post.id}`}
                                            class="flex flex-col sm:flex-row sm:items-baseline justify-between gap-1 sm:gap-4 group"
                                        >
                                            <h3 class="text-lg font-bold text-black font-comic-heading group-hover:underline decoration-2 underline-offset-2">
                                                {item.post.data.title}
                                            </h3>
                                            <time
                                                datetime={item.post.data.pubDate.toISOString()}
                                                class="text-text-muted text-sm whitespace-nowrap font-comic-body font-bold shrink-0"
                                            >
                                                {formatDate(
                                                    item.post.data.pubDate,
                                                )}
                                            </time>
                                        </a>
                                    </article>
                                );
                            }
                        })
                    }
                </div>

                <div id="no-results" class="hidden py-12 text-center">
                    <p class="font-comic-body text-xl text-black font-bold">
                        No posts found matching your criteria.
                    </p>
                </div>

                <div class="mt-16 text-center" id="load-more-container">
                    <button
                        id="load-more-btn"
                        class="comic-button bg-white !text-black hover:!bg-black hover:!text-white"
                        style={flatList.length <= 10 ? 'display: none;' : ''}
                    >
                        Load More
                    </button>
                </div>
                <!-- Spacer for infinite scroll triggering -->
                <div
                    id="infinite-scroll-trigger"
                    class="h-10 w-full pointer-events-none"
                >
                </div>
            </main>

            <!-- Sidebar -->
            <aside class="hidden lg:block">
                <div class="sticky top-24">
                    <div
                        class="bg-white border-2 border-black p-6 shadow-[8px_8px_0_0_#000]"
                    >
                        <h3
                            class="font-comic-heading text-2xl font-bold mb-4 border-b-2 border-black pb-2"
                        >
                            Categories
                        </h3>
                        <div class="flex flex-col gap-2" id="category-sidebar">
                            {
                                categories.map((cat) => (
                                    <button
                                        class="category-btn text-left px-3 py-2 font-comic-body font-bold border-2 border-transparent hover:border-black hover:bg-yellow-100 transition-all rounded-sm flex justify-between items-center group"
                                        data-category={cat}
                                        class:list={[
                                            {
                                                'bg-black text-white hover:!bg-black hover:!text-white':
                                                    cat === 'All',
                                            },
                                        ]}
                                    >
                                        <span>{cat}</span>
                                        {cat !== 'All' && (
                                            <span class="text-xs bg-black text-white px-1.5 py-0.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                                {
                                                    allPosts.filter((p) =>
                                                        p.data.categories.includes(
                                                            cat,
                                                        ),
                                                    ).length
                                                }
                                            </span>
                                        )}
                                    </button>
                                ))
                            }
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</Layout>

<script>
    document.addEventListener('astro:page-load', initBlog);

    // Fallback for initial load
    if (document.readyState === 'complete') {
        initBlog();
    } else {
        document.addEventListener('DOMContentLoaded', initBlog);
    }

    function initBlog() {
        const blogList = document.getElementById('blog-list');
        if (!blogList) return;

        const allItems = Array.from(blogList.querySelectorAll('.list-item'));
        const searchInput = document.getElementById(
            'search-input',
        ) as HTMLInputElement;
        const loadMoreBtn = document.getElementById('load-more-btn');
        const loadMoreContainer = document.getElementById(
            'load-more-container',
        );
        const noResults = document.getElementById('no-results');
        const infiniteScrollTrigger = document.getElementById(
            'infinite-scroll-trigger',
        );
        const categoryBtns = document.querySelectorAll('.category-btn');

        let visibleCount = 10;
        const batchSize = 10;

        let currentState = {
            search: '',
            category: 'All',
        };

        function filterAndRender() {
            const { search, category } = currentState;

            // 1. Filter Content
            let filteredPosts = allItems.filter((el) => {
                if (el.getAttribute('data-type') !== 'post') return false; // We filter posts first, years later

                const title = el.getAttribute('data-title') || '';
                const cats = JSON.parse(
                    el.getAttribute('data-categories') || '[]',
                );

                const matchesSearch = title.includes(search);
                const matchesCategory =
                    category === 'All' || cats.includes(category);

                return matchesSearch && matchesCategory;
            });

            // 2. Identify Active Years based on filtered posts
            const activeYears = new Set(
                filteredPosts.map((item) => item.getAttribute('data-year')),
            );

            // 3. Re-construct the "virtual" list of items to show, preserving original order
            const virtualList: Element[] = [];

            allItems.forEach((el) => {
                const type = el.getAttribute('data-type');
                const year = el.getAttribute('data-year');

                if (type === 'year') {
                    if (activeYears.has(year)) {
                        virtualList.push(el);
                    }
                } else if (type === 'post') {
                    if (filteredPosts.includes(el)) {
                        virtualList.push(el);
                    }
                }
            });

            // 4. Update DOM Visibility
            // Reset all items to hidden first
            allItems.forEach((el) => el.classList.add('hidden'));

            if (virtualList.length > 0) {
                noResults?.classList.add('hidden');

                // Show items up to visibleCount
                virtualList.forEach((el, idx) => {
                    if (idx < visibleCount) {
                        el.classList.remove('hidden');
                    }
                });

                if (visibleCount >= virtualList.length) {
                    loadMoreContainer?.classList.add('hidden');
                } else {
                    loadMoreContainer?.classList.remove('hidden');
                }
            } else {
                noResults?.classList.remove('hidden');
                loadMoreContainer?.classList.add('hidden');
            }

            return virtualList.length;
        }

        // Event Handlers
        searchInput?.addEventListener('input', (e) => {
            currentState.search = (
                e.target as HTMLInputElement
            ).value.toLowerCase();
            visibleCount = 10; // Reset pagination on new search
            filterAndRender();
        });

        categoryBtns.forEach((btn) => {
            btn.addEventListener('click', (e) => {
                const target = e.currentTarget as HTMLElement;
                currentState.category = target.dataset.category || 'All';

                // Update Button Styles
                categoryBtns.forEach((b) => {
                    b.classList.remove(
                        'bg-black',
                        'text-white',
                        'hover:!bg-black',
                        'hover:!text-white',
                    );
                    b.classList.add('hover:bg-yellow-100');
                });
                target.classList.add(
                    'bg-black',
                    'text-white',
                    'hover:!bg-black',
                    'hover:!text-white',
                );
                target.classList.remove('hover:bg-yellow-100');

                visibleCount = 10; // Reset pagination
                filterAndRender();
            });
        });

        // Pagination
        function loadMore() {
            visibleCount += batchSize;
            filterAndRender();
        }

        loadMoreBtn?.addEventListener('click', loadMore);

        if (infiniteScrollTrigger) {
            const observer = new IntersectionObserver(
                (entries) => {
                    const entry = entries[0];
                    if (entry.isIntersecting) {
                        // Check if we need to load more
                        // We run filterAndRender to know if we can load more?
                        // Actually, filterAndRender checks `visibleCount >= virtualList.length`
                        // So we just increment and re-render if button is visible
                        if (!loadMoreContainer?.classList.contains('hidden')) {
                            loadMore();
                        }
                    }
                },
                {
                    rootMargin: '200px',
                },
            );
            observer.observe(infiniteScrollTrigger);
        }

        // Initial Render
        filterAndRender();
    }
</script>
```
